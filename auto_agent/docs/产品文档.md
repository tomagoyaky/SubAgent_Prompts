# 产品文档

## 产品概述

本产品基于 deepagents 框架，实现了一个功能强大的深度代理（Deep Agent）系统。Deep Agent 是一种高级代理架构，通过结合规划工具、子代理、文件系统访问和详细提示，解决了传统 LLM 工具调用代理在处理复杂任务时的局限性。

## 核心功能

### 1. 规划与任务分解
- 内置 `write_todos` 工具，使代理能够将复杂任务分解为离散步骤
- 跟踪任务进度，并根据新信息动态调整计划
- 支持任务优先级管理和状态跟踪

### 2. 上下文管理
- 提供完整的文件系统工具集：`ls`、`read_file`、`write_file`、`edit_file`、`glob`、`grep`
- 允许代理将大型上下文卸载到内存中，防止上下文窗口溢出
- 支持处理可变长度的工具结果，如网络搜索、RAG 等

### 3. 子代理生成
- 内置 `task` 工具，使主代理能够生成专门的子代理进行上下文隔离
- 保持主代理上下文清洁的同时，深入处理特定子任务
- 支持为子代理配置自定义模型、工具和系统提示

### 4. 长期记忆
- 使用 LangGraph 的 BaseStore 实现跨线程的持久记忆
- 代理可以保存和检索来自先前对话的信息
- 支持通过 AGENTS.md 文件提供额外上下文

## 工具

除了用户提供的自定义工具外，deepagents 还包含以下内置工具：

- **规划工具**：`write_todos` - 用于创建和管理任务列表
- **文件管理工具**：
  - `ls` - 列出文件系统中的文件
  - `read_file` - 读取整个文件或文件的特定行数
  - `write_file` - 向文件系统写入新文件
  - `edit_file` - 编辑文件系统中的现有文件
  - `glob` - 使用模式匹配查找文件
  - `grep` - 在文件中搜索文本
- **子代理生成工具**：`task` - 用于生成和管理子代理

## 中间件

create_deep_agent 使用可自定义的中间件架构实现。用户可以提供额外的中间件来扩展功能、添加工具或实现自定义钩子。

### 主要中间件

#### 1. TodoListMiddleware
- 用于在代理执行过程中，根据代理的指令自动生成和管理 Todo List
- 可以通过系统提示自定义规划指令

#### 2. FilesystemMiddleware
- 用于在代理执行过程中，根据代理的指令自动操作文件系统
- 提供文件系统工具，支持短期和长期记忆管理
- 可以自定义存储后端和工具描述

#### 3. SubAgentMiddleware
- 允许通过 task 工具提供子代理
- 支持子代理的上下文隔离，保持主代理上下文清洁
- 可以为子代理配置自定义模型、工具和中间件

## 子代理

子代理是 Deep Agents 的主要特性之一，用户可以在 `subagents` 参数中指定自定义子代理，主代理可以将工作委托给这些子代理。

### 子代理配置

子代理应配置为字典列表，每个字典应包含以下字段：

```python
{
    "name": "子代理名称",
    "description": "子代理描述",
    "system_prompt": "子代理系统提示",
    "tools": [工具列表],
    "model": "可选的模型名称或模型实例",
    "middleware": "可选的中间件列表",
    "interrupt_on": "可选的中断配置"
}
```

### 编译子代理

对于复杂的工作流，可以提供预构建的 LangGraph 图作为子代理：

```python
from deepagents import CompiledSubAgent

# 创建自定义代理图
custom_graph = create_agent(
    model=your_model,
    tools=specialized_tools,
    prompt="您是专门用于数据分析的代理..."
)

# 将其包装为编译子代理
custom_subagent = CompiledSubAgent(
    name="data-analyzer",
    description="专门用于复杂数据分析任务的代理",
    runnable=custom_graph
)
```

## 中断机制

系统可以在指定的工具调用时暂停代理执行，以允许人工批准或修改。此功能通过 `interrupt_on` 参数选择加入。

```python
agent = create_deep_agent(
    tools=[get_weather],
    interrupt_on={
        "edit_file": True,  # 在每次编辑前暂停
        "write_file": {
            "allowed_decisions": ["approve", "edit", "reject"]
        }
    }
)
```

## 技能系统（优先支持的功能）

技能系统是我们目前最需要优先支持的功能，它允许为深度代理提供新的能力和专业知识。

### 技能与工具的区别
- **工具**：通常覆盖低级功能，如原生文件系统操作或规划
- **技能**：包含完成任务的详细说明、参考信息和其他资产，如模板

### 技能的优势
- 技能文件仅在代理确定对当前提示有用时才加载
- 这种渐进式披露减少了代理在启动时需要考虑的令牌和上下文数量
- 可以轻松扩展代理的专业知识领域

### 添加技能

```python
from deepagents import create_deep_agent
from langgraph.checkpoint.memory import MemorySaver

checkpointer = MemorySaver()

agent = create_deep_agent(
    skills=["./skills/"],
    checkpointer=checkpointer,
)

result = agent.invoke(
    {
        "messages": [
            {
                "role": "user",
                "content": "什么是 langgraph？",
            }
        ],
        # 种子默认 StateBackend 的状态内文件系统（虚拟路径必须以 "/" 开头）
        "files": skills_files
    },
    config={"configurable": {"thread_id": "12345"}},
)
```

## 内存管理

使用 `AGENTS.md` 文件为深度代理提供额外的上下文。可以在创建深度代理时将一个或多个文件路径传递给 `memory` 参数：

```python
from deepagents import create_deep_agent
from langgraph.checkpoint.memory import MemorySaver

checkpointer = MemorySaver()

agent = create_deep_agent(
    memory=[
        "./AGENTS.md"
    ],
    checkpointer=checkpointer,
)
```

## 自定义配置

### 模型配置
- 默认使用 `claude-sonnet-4-5-20250929`
- 可以通过 `provider:model` 格式快速切换模型，如 `openai:gpt-5`
- 支持传入任何 LangChain 模型对象

### 大模型抽象

根据个人偏好，项目对大模型进行了以下抽象设计：

#### Provider 和 Factory 模式
- 对 `ollama` 和 `deepseek-chat` 等大模型进行抽象，使用 Provider 和 Factory 模式管理
- Provider 负责与具体模型服务的交互
- Factory 负责创建和管理不同类型的 Provider 实例

#### 统一接口设计
- 所有大模型输出统一定义一个 `chat` 方法
- 每个大模型都支持 `generate` 和 `stream` 方法
- 使用哪种方法取决于 `chat` 方法的 `stream` 参数是否为 `true`

```python
# 统一接口示例
class BaseModelProvider:
    def chat(self, messages, stream=False):
        if stream:
            return self.stream(messages)
        return self.generate(messages)
    
    def generate(self, messages):
        raise NotImplementedError
    
    def stream(self, messages):
        raise NotImplementedError

class OllamaProvider(BaseModelProvider):
    def generate(self, messages):
        # 实现 Ollama 模型的生成逻辑
        pass
    
    def stream(self, messages):
        # 实现 Ollama 模型的流式输出逻辑
        pass

class DeepSeekProvider(BaseModelProvider):
    def generate(self, messages):
        # 实现 DeepSeek 模型的生成逻辑
        pass
    
    def stream(self, messages):
        # 实现 DeepSeek 模型的流式输出逻辑
        pass

class ModelFactory:
    @staticmethod
    def get_provider(model_type, config):
        if model_type == "ollama":
            return OllamaProvider(config)
        elif model_type == "deepseek":
            return DeepSeekProvider(config)
        raise ValueError(f"Unknown model type: {model_type}")
```

### 系统提示
- Deep Agents 带有内置系统提示，灵感来自 Claude Code 的系统提示
- 建议为每个特定用例创建自定义系统提示

### 后端配置
- 支持多种后端存储选项：
  - **StateBackend**：默认后端，使用内存存储
  - **StoreBackend**：使用 LangGraph 的存储系统
  - **FilesystemBackend**：使用实际文件系统

### YAML 配置文件结构

项目支持使用 YAML 格式的配置文件来管理代理的各项设置。以下是配置文件的结构和字段说明：

```yaml
# 基本配置
name: "research-agent"  # 代理名称
description: "用于研究任务的深度代理"  # 代理描述
system_prompt: "您是一名专家研究员..."  # 系统提示

# 模型配置
model:
  type: "ollama"  # 模型类型 (ollama, deepseek, openai 等)
  name: "llama3.1"  # 模型名称
  temperature: 0.7  # 温度参数
  max_tokens: 4096  # 最大令牌数

# 工具配置
tools:
  - name: "internet_search"  # 工具名称
    description: "运行网络搜索"  # 工具描述
    enabled: true  # 是否启用
  - name: "write_todos"  # 内置规划工具
    enabled: true
  - name: "task"  # 内置子代理工具
    enabled: true

# 中间件配置
middleware:
  - type: "TodoListMiddleware"  # 中间件类型
    enabled: true
    config:
      system_prompt: "使用 write_todos 工具来..."
  - type: "FilesystemMiddleware"
    enabled: true
    config:
      custom_tool_descriptions:
        ls: "使用 ls 工具列出..."
        read_file: "使用 read_file 工具读取..."
  - type: "SubAgentMiddleware"
    enabled: true

# 子代理配置
subagents:
  - name: "data-analyzer"  # 子代理名称
    description: "专门用于数据分析的子代理"  # 子代理描述
    system_prompt: "您是一名数据分析师..."  # 子代理系统提示
    tools:
      - name: "internet_search"
        enabled: true
    model:
      type: "deepseek"
      name: "deepseek-chat"

# 技能和内存配置
skills:
  - "./skills/langgraph-docs/"  # 技能目录路径
  - "./skills/research/"

memory:
  - "./memory/AGENTS.md"  # 内存文件路径

# 后端存储配置
backend:
  type: "StateBackend"  # 后端类型 (StateBackend, StoreBackend, FilesystemBackend)
  config:
    # StateBackend 特定配置
    pass
  # 或 FilesystemBackend 配置
  # type: "FilesystemBackend"
  # config:
  #   root_dir: "/path/to/project"

# 中断机制配置
interrupt_on:
  write_file: true  # 在写入文件前暂停
  edit_file: true   # 在编辑文件前暂停
  task: false       # 在生成子代理前不暂停

# 日志配置
logging:
  level: "INFO"  # 日志级别 (DEBUG, INFO, WARNING, ERROR)
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"  # 日志格式
  file: "./logs/agent.log"  # 日志文件路径
```

#### 配置字段说明

1. **基本配置**
   - `name`：代理的名称，用于标识不同的代理实例
   - `description`：代理的描述，提供关于代理用途的信息
   - `system_prompt`：代理的系统提示，指导代理的行为和响应方式

2. **模型配置**
   - `type`：模型类型，如 `ollama`、`deepseek`、`openai` 等
   - `name`：具体的模型名称，如 `llama3.1`、`deepseek-chat`、`gpt-4o` 等
   - `temperature`：控制模型输出的随机性，值越高输出越随机
   - `max_tokens`：模型生成的最大令牌数

3. **工具配置**
   - `name`：工具的名称
   - `description`：工具的描述
   - `enabled`：是否启用该工具

4. **中间件配置**
   - `type`：中间件的类型
   - `enabled`：是否启用该中间件
   - `config`：中间件的特定配置选项

5. **子代理配置**
   - `name`：子代理的名称
   - `description`：子代理的描述
   - `system_prompt`：子代理的系统提示
   - `tools`：子代理可用的工具列表
   - `model`：子代理使用的模型配置

6. **技能和内存配置**
   - `skills`：技能目录路径列表
   - `memory`：内存文件路径列表

7. **后端存储配置**
   - `type`：后端存储类型
   - `config`：后端存储的特定配置选项

8. **中断机制配置**
   - 以工具名称为键，布尔值为值，表示是否在该工具调用前暂停执行

9. **日志配置**
   - `level`：日志级别
   - `format`：日志格式
   - `file`：日志文件路径

通过 YAML 配置文件，用户可以更方便地管理和调整代理的各项设置，而无需在代码中硬编码这些值。配置文件可以根据不同的使用场景进行定制，为代理提供更灵活的配置选项。

## 使用示例

### 基本用法

```python
import os
from typing import Literal
from tavily import TavilyClient
from deepagents import create_deep_agent

tavily_client = TavilyClient(api_key=os.environ["TAVILY_API_KEY"])

# 网络搜索工具
def internet_search(
    query: str,
    max_results: int = 5,
    topic: Literal["general", "news", "finance"] = "general",
    include_raw_content: bool = False,
):
    """运行网络搜索"""
    return tavily_client.search(
        query,
        max_results=max_results,
        include_raw_content=include_raw_content,
        topic=topic,
    )

# 系统提示
research_instructions = """您是一名专家研究员。您的工作是进行 thorough 研究，然后撰写一份 polished 报告。

您可以使用 internet_search 工具作为收集信息的主要手段。"""

# 创建深度代理
agent = create_deep_agent(
    tools=[internet_search],
    system_prompt=research_instructions,
)

# 调用代理
result = agent.invoke({"messages": [{"role": "user", "content": "什么是 langgraph？"}]})
```

### 高级用法（包含子代理）

```python
from deepagents import create_deep_agent

# 定义子代理
research_subagent = {
    "name": "research-agent",
    "description": "用于深入研究问题",
    "system_prompt": "您是一名出色的研究员",
    "tools": [internet_search],
    "model": "openai:gpt-4o",  # 可选覆盖，默认为主代理模型
}

# 创建深度代理
agent = create_deep_agent(
    model="anthropic:claude-sonnet-4-20250514",
    tools=[internet_search],
    system_prompt=research_instructions,
    subagents=[research_subagent]
)
```

## 项目文件系统结构

为了实现清晰的代码分层和模块化设计，Agent 项目采用了以下文件系统结构：

```
agent-project/
├── src/                  # 源代码目录
│   ├── agent/            # 代理核心模块
│   │   ├── __init__.py
│   │   ├── main.py       # 主代理实现
│   │   └── config.py     # 代理配置
│   ├── tools/            # 工具模块
│   │   ├── __init__.py
│   │   ├── planning.py   # 规划工具
│   │   ├── filesystem.py # 文件系统工具
│   │   └── subagent.py   # 子代理工具
│   ├── middleware/       # 中间件模块
│   │   ├── __init__.py
│   │   ├── todo.py       # TodoListMiddleware
│   │   ├── filesystem.py # FilesystemMiddleware
│   │   └── subagent.py   # SubAgentMiddleware
│   ├── backends/         # 后端存储模块
│   │   ├── __init__.py
│   │   ├── state.py      # StateBackend
│   │   ├── store.py      # StoreBackend
│   │   └── filesystem.py # FilesystemBackend
│   └── utils/            # 工具函数模块
│       ├── __init__.py
│       ├── helpers.py    # 辅助函数
│       ├── logging.py    # 日志处理
│       ├── config.py     # 配置加载
│       ├── stream.py     # 大模型流式输出处理
│       ├── model.py      # 大模型 Provider 和 Factory 实现
│       └── errors.py     # 错误处理
├── skills/               # 技能文件目录
│   ├── langgraph-docs/   # LangGraph 文档技能
│   │   └── SKILL.md
│   └── research/         # 研究技能
│       └── SKILL.md
├── memory/               # 内存文件目录
│   └── AGENTS.md         # 代理记忆文件
├── config/               # 配置文件目录
│   └── settings.py       # 项目设置
├── docs/                 # 文档目录
│   ├── 产品文档.md       # 产品文档
│   ├── deepagents.py.md  # deepagents 参考文档
│   └── CustomizeDeepAgents.md # 自定义配置文档
├── examples/             # 示例代码目录
│   ├── basic_usage.py    # 基本用法示例
│   └── advanced_usage.py # 高级用法示例
├── tests/                # 测试目录
│   ├── test_agent.py     # 代理测试
│   ├── test_tools.py     # 工具测试
│   └── test_middleware.py # 中间件测试
├── requirements.txt      # 依赖文件
├── setup.py              # 安装脚本
└── README.md             # 项目说明
```

### 目录结构说明

1. **src/agent/**：代理核心模块，包含主代理实现和配置
2. **src/tools/**：工具模块，包含规划、文件系统和子代理相关工具
3. **src/middleware/**：中间件模块，实现各种功能扩展
4. **src/backends/**：后端存储模块，支持不同的存储方式
5. **src/utils/**：工具函数模块，提供各种独立功能模块
   - `logging.py`：日志处理
   - `config.py`：配置加载
   - `stream.py`：大模型流式输出处理
   - `model.py`：大模型 Provider 和 Factory 实现
   - `errors.py`：错误处理
   - `helpers.py`：辅助函数
6. **skills/**：技能文件目录，按领域组织不同的技能
7. **memory/**：内存文件目录，存储 AGENTS.md 等记忆文件
8. **config/**：配置文件目录，存储项目设置
9. **docs/**：文档目录，包含产品文档和参考资料
10. **examples/**：示例代码目录，提供使用示例
11. **tests/**：测试目录，包含各种测试用例

### 代码分层

项目采用清晰的分层架构：

1. **核心层**：agent 模块，实现代理的基本功能和流程
2. **工具层**：tools 模块，提供各种功能工具
3. **中间件层**：middleware 模块，扩展代理功能
4. **存储层**：backends 模块，处理数据存储
5. **应用层**：examples 和 skills，提供具体应用场景

这种分层设计使得代码结构清晰，易于维护和扩展。各模块之间通过明确的接口进行交互，降低了耦合度，提高了代码的可测试性和可重用性。

## 单元测试

为了确保项目的质量和稳定性，我们采用了全面的单元测试策略。以下是项目的测试结构和测试用例说明：

### 测试目录结构

```
tests/
├── __init__.py
├── test_agent.py         # 代理核心功能测试
├── test_tools.py         # 工具模块测试
├── test_middleware.py    # 中间件测试
├── test_backends.py      # 后端存储测试
├── test_utils.py         # 工具函数测试
└── fixtures/             # 测试夹具目录
    ├── __init__.py
    └── test_data.py      # 测试数据
```

### 主要测试文件

#### 1. test_agent.py
- 测试代理的核心功能，包括初始化、invoke 方法、流式输出等
- 测试代理的配置加载和验证
- 测试代理与工具的交互

#### 2. test_tools.py
- 测试内置工具的功能，如 write_todos、文件系统工具、子代理工具
- 测试工具的参数验证和错误处理
- 测试工具的返回值格式

#### 3. test_middleware.py
- 测试各种中间件的功能，如 TodoListMiddleware、FilesystemMiddleware、SubAgentMiddleware
- 测试中间件的初始化和配置
- 测试中间件与代理的交互

#### 4. test_backends.py
- 测试不同后端存储的功能，如 StateBackend、StoreBackend、FilesystemBackend
- 测试后端存储的读写操作
- 测试后端存储的错误处理

#### 5. test_utils.py
- 测试工具函数模块，如日志处理、配置加载、流式输出处理、大模型抽象等
- 测试工具函数的边界情况
- 测试工具函数的性能

### 编写测试用例

项目使用 Python 的标准测试框架 `unittest` 或 `pytest` 编写测试用例。以下是编写测试用例的最佳实践：

1. **测试用例命名**：使用 `test_` 前缀，后跟要测试的功能名称
2. **测试夹具**：使用 `setUp` 和 `tearDown` 方法设置和清理测试环境
3. **测试断言**：使用适当的断言方法验证测试结果
4. **测试覆盖**：确保测试覆盖主要功能和边界情况
5. **测试隔离**：确保测试用例之间相互独立，不共享状态

### 运行测试

#### 使用 unittest

```bash
# 运行所有测试
python -m unittest discover tests

# 运行特定测试文件
python -m unittest tests.test_agent

# 运行特定测试用例
python -m unittest tests.test_agent.TestAgent.test_init
```

#### 使用 pytest

```bash
# 安装 pytest
pip install pytest

# 运行所有测试
pytest tests/

# 运行特定测试文件
pytest tests/test_agent.py

# 运行特定测试用例
pytest tests/test_agent.py::TestAgent::test_init

# 显示测试覆盖率
pytest --cov=src tests/
```

### 测试覆盖范围

项目的测试覆盖范围包括：

- **核心功能**：代理的初始化、配置、调用和流式输出
- **工具功能**：所有内置工具的功能和错误处理
- **中间件功能**：所有中间件的功能和配置
- **后端存储**：所有后端存储的读写操作和错误处理
- **工具函数**：所有工具函数的功能和边界情况

通过全面的单元测试，我们可以确保项目的质量和稳定性，减少回归错误，并提高代码的可维护性。

## 总结

本产品基于 deepagents 框架，实现了一个功能强大的深度代理系统，具有以下优势：

- **强大的规划能力**：通过内置的任务管理工具，能够分解复杂任务并跟踪进度
- **高效的上下文管理**：通过文件系统工具，有效管理大型上下文，防止上下文窗口溢出
- **灵活的子代理系统**：支持生成专门的子代理进行上下文隔离，深入处理特定任务
- **持久的记忆功能**：实现跨线程的持久记忆，提高代理的连续性和一致性
- **可扩展的技能系统**：通过技能文件轻松扩展代理的专业知识领域
- **清晰的代码分层**：采用模块化设计，代码结构清晰，易于维护和扩展

这些功能使得本产品能够处理更复杂、更长期的任务，为用户提供更智能、更可靠的代理服务。